<?php
/* Magento payment module for NETBANX                            *
 * Copyright 2009, Independant IT Consulting Limited             *
 *                                                               *
 * This is commercially licensed code, before installing         *
 * or using, you must agree with the Software License Agreement  *
 * which you should have been given, if not it's available at    *
 * http://iitc.info/products/docs/singledomainlicense            *
 * (If unavailable above, email sales@iitc.info for a copy.)     */

class IITC_Netbanx_PaymentController extends Mage_Core_Controller_Front_Action {

  public function indexAction() {
    $this->loadLayout();
    $this->renderLayout();
  }		
 		
  public function redirectAction() {
    $session = Mage::getSingleton('checkout/session');
    $order = Mage::getModel('sales/order')->loadbyIncrementId($session->getLastRealOrderId());

    // Prevent ugly errors
    $data = $order->getData();
    if (empty($data))
      return '';

    $order->addStatusToHistory(Mage_Sales_Model_Order::STATE_HOLDED,
			       'Customer redirected to NETBANX payment page, awaiting payment confirmation from NETBANX',
			       true);
    $order->save();
    
    $this->getResponse()
      ->setBody($this->getLayout()
		->createBlock('Netbanx/redirect')
		->setOrder($order)
		->setSession($session)
		->toHtml());
  }

  public function lookupAction() {
    $this->getResponse()->setBody($this->getLayout()->createBlock('Netbanx/lookup')->toHtml());
  }

  public function callbackAction() {
    $this->getResponse()->setBody($this->getLayout()->createBlock('Netbanx/callback')->toHtml());
  }

  public function successAction() {
    $session = Mage::getSingleton('checkout/session');
    $order = Mage::getModel('sales/order')->loadbyIncrementId($session->getLastRealOrderId());

    // Log access if order details are there
    $data = $order->getData();
    if (!empty($data)) {
      $order->addStatusToHistory($order->getStatus(),
				 'Customer redirected to Success page, waiting payment confirmation from NETBANX.',
				 false);
      $order->save();
    }

    // Clear shopping cart 
    $quote = $session->getQuote();
    $quote->setIsActive(false);
    $quote->delete();

    $this->loadLayout();
    $this->renderLayout();
  }

  public function failureAction() {
    $this->loadLayout();
    $this->renderLayout();
  }
  public function returnAction() {
    $session = Mage::getSingleton('checkout/session');
    $order = Mage::getModel('sales/order')->loadbyIncrementId($session->getLastRealOrderId());

    // Log access if order details are there
    $data = $order->getData();
    if (!empty($data)) {
      $order->addStatusToHistory($order->getStatus(),
				 'Customer clicked "Back to Merchant" link on NETBANX page.',
				 false);
      $order->save();
    }

    $this->loadLayout();
    $this->renderLayout();
  }
}
?>
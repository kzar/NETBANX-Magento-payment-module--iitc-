<?php
/* Magento payment module for NETBANX                            *
 * Copyright 2010, Independant IT Consulting Limited             *
 *                                                               *
 * This is commercially licensed code, before installing         *
 * or using, you must agree with the Software License Agreement  *
 * which you should have been given, if not it's available at    *
 * http://iitc.info/products/docs/singledomainlicense            *
 * (If unavailable above, email sales@iitc.info for a copy.)     */

// Example useage:
// {{block type="Netbanx/lookup" order_id=$order.increment_id}}

class IITC_Netbanx_Block_Lookup extends Mage_Core_Block_Abstract {
  protected function _toHtml() {
    if ($this->getOrderId())
      return $this->netbanxRef($this->getOrderId());
  }

  function netbanxRef($orderNumber) {
    $db = Mage::getSingleton('core/resource')->getConnection('core_read');

    $orderNumber = $db->quote($orderNumber);
    $SQL = "select value from sales_order_entity_text where entity_id in (select entity_id from sales_order_entity where parent_id=(select entity_id from sales_order where increment_id=" . $orderNumber . ")) and value like \"%Reference:%\"";

    $data = $db->fetchAll($SQL);

    if ($data && array_key_exists(0, $data) && array_key_exists('value', $data[0])) {
      $data = $data[0]['value'];
      $data = explode(": ", $data);

      if (count($data) > 1)
        return $data[1];
    }
    return "";
  }
}
?>